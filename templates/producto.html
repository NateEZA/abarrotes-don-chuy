{% extends "base.html" %}
{% block titulo %}{{ producto.nombre }} - Abarrotes Don Chuy{% endblock %}
{% block contenido %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin-bottom: 3rem;">
    <div>
        <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <img src="{{ url_for('static', filename='uploads/' + producto.imagen) }}" alt="{{ producto.nombre }}" 
                 style="width: 100%; height: 500px; object-fit: cover; background: #e9ecef;">
        </div>
    </div>
    <div>
        <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <h1 style="color: #2c3e50; margin-bottom: 1rem;">{{ producto.nombre }}</h1>
            <div style="margin-bottom: 1rem;">
                {% set calif_promedio = producto.calificacion_promedio() %}
                {% for i in range(5) %}
                    <span style="color: {% if i < calif_promedio %}#f39c12{% else %}#e0e0e0{% endif %}; font-size: 1.5rem;">‚òÖ</span>
                {% endfor %}
                <span style="color: #7f8c8d; margin-left: 0.5rem;">({{ resenas|length }} rese√±as)</span>
            </div>
            <div style="font-size: 2.5rem; color: #27ae60; font-weight: bold; margin-bottom: 1.5rem;">${{ "%.2f"|format(producto.precio) }}</div>
            <div style="margin-bottom: 1.5rem;">
                <p style="color: #7f8c8d; margin-bottom: 0.5rem;"><strong>Vendedor:</strong> {{ producto.vendedor.nombre_usuario }}</p>
                <p style="color: {% if producto.stock > 0 %}#27ae60{% else %}#e74c3c{% endif %};"><strong>Stock:</strong> {{ producto.stock }} unidades disponibles</p>
            </div>
            <div style="border-top: 2px solid #e0e0e0; padding-top: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">Descripci√≥n</h3>
                <p style="color: #555; line-height: 1.6;">{{ producto.descripcion }}</p>
            </div>
            {% if session.rol == 'Comprador' and producto.stock > 0 %}
            <form method="POST" action="{{ url_for('agregar_al_carrito', id_producto=producto.id) }}">
                <div class="grupo-formulario">
                    <label for="cantidad">Cantidad:</label>
                    <input type="number" id="cantidad" name="cantidad" class="control-formulario" value="1" min="1" max="{{ producto.stock }}" style="max-width: 150px;">
                </div>
                <button type="submit" class="btn btn-primario btn-bloque">üõí Agregar al Carrito</button>
            </form>
            {% elif producto.stock == 0 %}
            <button class="btn btn-peligro btn-bloque" disabled>Producto Agotado</button>
            {% elif not session.id_usuario %}
            <a href="{{ url_for('login') }}" class="btn btn-primario btn-bloque">Inicia sesi√≥n para comprar</a>
            {% endif %}
        </div>
    </div>
</div>

<div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    <h2 style="color: #2c3e50; margin-bottom: 2rem;">üí¨ Rese√±as de Clientes</h2>
    {% if session.id_usuario and puede_resenar %}
    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <h3 style="color: #2c3e50; margin-bottom: 1rem;">Escribe tu rese√±a</h3>
        <form method="POST" action="{{ url_for('agregar_resena', id_producto=producto.id) }}">
            <div class="grupo-formulario">
                <label for="calificacion">Calificaci√≥n:</label>
                <select id="calificacion" name="calificacion" class="control-formulario" required style="max-width: 200px;">
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 estrellas)</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 estrellas)</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê (3 estrellas)</option>
                    <option value="2">‚≠ê‚≠ê (2 estrellas)</option>
                    <option value="1">‚≠ê (1 estrella)</option>
                </select>
            </div>
            <div class="grupo-formulario">
                <label for="comentario">Comentario:</label>
                <textarea id="comentario" name="comentario" class="control-formulario" rows="4"></textarea>
            </div>
            <button type="submit" class="btn btn-primario">Enviar Rese√±a</button>
        </form>
    </div>
    {% elif session.id_usuario and not puede_resenar %}
    <div style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
        <strong>Nota:</strong> Solo puedes calificar productos que hayas comprado previamente.
    </div>
    {% endif %}
    
    {% if resenas %}
        {% for resena in resenas %}
        <div style="border-bottom: 2px solid #e0e0e0; padding: 1.5rem 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div>
                    <strong style="color: #2c3e50;">{{ resena.usuario.nombre_usuario }}</strong>
                    <span style="color: #7f8c8d; margin-left: 1rem; font-size: 0.9rem;">{{ resena.fecha_creacion.strftime('%d/%m/%Y') }}</span>
                </div>
                <div>
                    {% for i in range(5) %}
                        <span style="color: {% if i < resena.calificacion %}#f39c12{% else %}#e0e0e0{% endif %}; font-size: 1.2rem;">‚òÖ</span>
                    {% endfor %}
                </div>
            </div>
            {% if resena.comentario %}
            <p style="color: #555; line-height: 1.6; margin-top: 0.5rem;">{{ resena.comentario }}</p>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
    <p style="text-align: center; color: #7f8c8d; padding: 2rem;">A√∫n no hay rese√±as. ¬°S√© el primero en calificar!</p>
    {% endif %}
</div>
<div style="margin-top: 2rem;"><a href="{{ url_for('index') }}" class="btn btn-secundario">‚Üê Volver a la tienda</a></div>
{% endblock %}